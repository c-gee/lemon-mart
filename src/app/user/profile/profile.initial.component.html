<mat-toolbar color="accent">
  <h5>User Profile</h5>
</mat-toolbar>

@if (formGroup) {
<div>
  <mat-horizontal-stepper #stepper="matHorizontalStepper">
    <mat-step [stepControl]="formGroup">
      <form [formGroup]="formGroup">
        <ng-template matStepLabel>Account Information</ng-template>
        <div class="stepContent">
          <div formGroupName="name">
            <div fxLayout="row" fxLayout.lt-sm="column" fxLayoutGap="10px">
              <mat-form-field appearance="outline" fxFlex="40%">
                <mat-label>First Name</mat-label>
                <input #first matInput placeholder="First Name" aria-label="First Name"
                  formControlName="first" />
                <mat-error [input]="first" [group]="formGroup"
                  [appFieldError]="ErrorSets['RequiredText']"></mat-error>
              </mat-form-field>
              <mat-form-field appearance="outline" fxFlex="20%">
                <mat-label>MI</mat-label>
                <input #middle matInput placeholder="MI" aria-label="Middle Initial"
                  formControlName="middle" />
                <mat-error [input]="middle" [group]="formGroup"
                  [appFieldError]="{ error: 'invalid', message: 'Only initial' }"></mat-error>
              </mat-form-field>
              <mat-form-field appearance="outline" fxFlex="40%">
                <mat-label>Last Name</mat-label>
                <input #last matInput placeholder="Last Name" aria-label="Last Name"
                  formControlName="last" />
                <mat-error [input]="last" [group]="formGroup"
                  [appFieldError]="ErrorSets['RequiredText']"></mat-error>
              </mat-form-field>
            </div>
          </div>
          <div fxLayout="row" fxLayout.lt-sm="column" fxLayoutGap="10px">
            <mat-form-field appearance="outline" fxFlex="50%">
              <mat-label>Date of Birth</mat-label>
              <input #dob matInput aria-label="Date of Birth"
                formControlName="dateOfBirth" [min]="minDate" [max]="now"
                [matDatepicker]="dateOfBirthPicker">
              @if (formGroup.get('dateOfBirth')?.value) {
              <mat-hint>{{ age }} year(s) old</mat-hint>
              }
              <mat-datepicker-toggle matSuffix
                [for]="dateOfBirthPicker"></mat-datepicker-toggle>
              <mat-datepicker #dateOfBirthPicker></mat-datepicker>
              <mat-error [input]="dob" [group]="formGroup" [appFieldError]="{
              error: 'invalid',
              message: 'Date must be within the last 100 years'
            }"></mat-error>
            </mat-form-field>
            <mat-form-field appearance="outline" fxFlex="50%">
              <mat-label>E-mail</mat-label>
              <input #email matInput aria-label="E-mail" formControlName="email" />
              <mat-hint>Only your manager can update your e-mail.</mat-hint>
              <mat-error [input]="email" [group]="formGroup"
                appFieldError="invalid"></mat-error>
            </mat-form-field>
          </div>
        </div>
      </form>
    </mat-step>
    <mat-step [stepControl]="formGroup">
      <form [formGroup]="formGroup">
        <ng-template matStepLabel>Contact Information</ng-template>
        <div class="stepContent">
          <div formGroupName="address">
            <div fxLayout="row" fxLayout.lt-sm="column" fxLayoutGap="10px">
              <mat-form-field appearance="outline" fxFlex>
                <mat-label>Address Line 1</mat-label>
                <input #line1 matInput aria-label="Address Line 1"
                  formControlName="line1" />
                <mat-error [input]="line1" [group]="formGroup"
                  [appFieldError]="ErrorSets['RequiredText']"></mat-error>
              </mat-form-field>
            </div>
            <div fxLayout="row" fxLayout.lt-sm="column" fxLayoutGap="10px">
              <mat-form-field appearance="outline" fxFlex>
                <mat-label>Line 2</mat-label>
                <input #line2 matInput aria-label="Address Line 2"
                  formControlName="line2" />
                <mat-hint>Optional</mat-hint>
                <mat-error [input]="line2" [group]="formGroup"
                  [appFieldError]="ErrorSets['OptionalText']"></mat-error>
              </mat-form-field>
            </div>
            <div fxLayout="row" fxLayout.lt-sm="column" fxLayoutGap="10px">
              <mat-form-field appearance="outline" fxFlex="40%">
                <mat-label>City</mat-label>
                <input #city matInput aria-label="City" formControlName="city" />
                <mat-error [input]="city" [group]="formGroup"
                  [appFieldError]="ErrorSets['RequiredText']"></mat-error>
              </mat-form-field>
              <mat-form-field appearance="outline" fxFlex="30%">
                <mat-label>State</mat-label>
                <input #state matInput type="text" aria-label="State"
                  formControlName="state" [matAutocomplete]="stateAuto" />
                <mat-autocomplete #stateAuto="matAutocomplete">
                  @for (state of states$ | async; track state) {
                  <mat-option [value]="state.name">
                    {{ state.name }}
                  </mat-option>
                  }
                </mat-autocomplete>
                <mat-error [input]="state" [group]="formGroup"
                  appFieldError="required"></mat-error>
              </mat-form-field>
              <mat-form-field appearance="outline" fxFlex="30%">
                <mat-label>Zip Code</mat-label>
                <input #zip matInput aria-label="Zip Code" formControlName="zip" />
                <mat-error [input]="zip" [group]="formGroup"
                  appFieldError="invalid"></mat-error>
              </mat-form-field>
            </div>
          </div>
          <div fxLayout="row" fxLayout.lt-sm="column">
            <mat-list formArrayName="phones">
              <h2 mat-subheader>
                Phone Number(s)
                <button mat-button (click)="addPhone()">
                  <mat-icon>add</mat-icon>
                  Add Phone
                </button>
              </h2>
              @for (position of phonesArray.controls; track position; let i = $index) {
              <mat-list-item [formGroupName]="i">
                <mat-form-field appearance="outline" fxFlex="100px">
                  <mat-label>Type</mat-label>
                  <mat-select formControlName="type">
                    @for (type of PhoneTypes; track type) {
                    <mat-option [value]="convertTypeToPhoneType(type)">
                      {{ type }}
                    </mat-option>
                    }
                  </mat-select>
                </mat-form-field>
                <mat-form-field appearance="outline" fxFlex fxFlexOffset="10px">
                  <mat-label>Number</mat-label>
                  <input matInput type="text" formControlName="digits"
                    aria-label="Phone number" mask="(000) 000-0000" prefix="+1" />
                  @if (
                  phonesArray.controls[i].invalid && phonesArray.controls[i].touched
                  ) {
                  <mat-error> A valid phone number is required </mat-error>
                  }
                </mat-form-field>
                <div fxLayoutAlign="center center" fxFlex="33px">
                  <button mat-icon-button (click)="phonesArray.removeAt(i)">
                    <mat-icon>delete</mat-icon>
                  </button>
                </div>
              </mat-list-item>
              }
            </mat-list>
          </div>
        </div>
      </form>
    </mat-step>
    <mat-step [stepControl]="formGroup">
      <form [formGroup]="formGroup" (ngSubmit)="save(formGroup)">
        <ng-template matStepLabel>Review</ng-template>
        <div class="stepContent">
          Review and update your user profile.
          <app-view-user [user]="formGroup.getRawValue()"></app-view-user>
        </div>
        <div fxLayout="row" class="top-pad">
          <button mat-button matStepperPrevious>Back</button>
          <div class="flex-space"></div>
          @if (userError) {
          <div class="mat-caption error">{{ userError }}</div>
          }
          <button mat-button color="warn" (click)="stepper.reset()">
            Reset
          </button>
          <button mat-raised-button matStepperNext color="primary" type="submit"
            [disabled]="formGroup.invalid">
            Update
          </button>
        </div>
      </form>
    </mat-step>
  </mat-horizontal-stepper>
</div>
}
